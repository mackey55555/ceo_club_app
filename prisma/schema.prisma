// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 会員ステータスマスタ
model MemberStatus {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(50)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  users User[]

  @@map("member_statuses")
}

// サークルマスタ
model Circle {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique @db.VarChar(100)
  sortOrder Int      @default(0) @map("sort_order")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  userCircles UserCircle[]

  @@map("circles")
}

// 会員テーブル
model User {
  id              String   @id @default(uuid()) @db.Uuid
  email           String   @unique @db.VarChar(255)
  passwordHash    String?  @map("password_hash") @db.VarChar(255)
  fullName        String   @map("full_name") @db.VarChar(100)
  profileImageUrl String?  @map("profile_image_url") @db.VarChar(500)
  gender          String?  @db.VarChar(20) // 'male', 'female', 'other'
  birthDate       DateTime? @map("birth_date") @db.Date
  companyName     String?  @map("company_name") @db.VarChar(200)
  district        String?  @db.VarChar(100)
  statusId        String   @map("status_id") @db.Uuid
  expoPushToken   String?  @map("expo_push_token") @db.VarChar(255)
  termsAgreed     Boolean  @default(false) @map("terms_agreed")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  status      MemberStatus @relation(fields: [statusId], references: [id])
  userCircles UserCircle[]
  createdNews News[]       @relation("NewsCreator")
  createdEvents Event[]    @relation("EventCreator")
  applications EventApplication[]

  @@map("users")
}

// 会員-サークル中間テーブル
model UserCircle {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  circleId  String   @map("circle_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  circle Circle @relation(fields: [circleId], references: [id], onDelete: Cascade)

  @@unique([userId, circleId])
  @@map("user_circles")
}

// お知らせステータスマスタ
model NewsStatus {
  id   String @id @default(uuid()) @db.Uuid
  name String @unique @db.VarChar(50)

  news News[]

  @@map("news_statuses")
}

// お知らせテーブル
model News {
  id          String      @id @default(uuid()) @db.Uuid
  title       String      @db.VarChar(200)
  body        String      @db.Text
  thumbnailUrl String?     @map("thumbnail_url") @db.VarChar(500)
  statusId    String      @map("status_id") @db.Uuid
  publishAt   DateTime?   @map("publish_at") @db.Timestamptz(6)
  createdBy   String      @map("created_by") @db.Uuid
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  status    NewsStatus @relation(fields: [statusId], references: [id])
  creator   User       @relation("NewsCreator", fields: [createdBy], references: [id])

  @@map("news")
}

// イベントステータスマスタ
model EventStatus {
  id   String @id @default(uuid()) @db.Uuid
  name String @unique @db.VarChar(50)

  events Event[]

  @@map("event_statuses")
}

// イベントテーブル
model Event {
  id            String    @id @default(uuid()) @db.Uuid
  title         String    @db.VarChar(200)
  body          String    @db.Text
  thumbnailUrl  String?   @map("thumbnail_url") @db.VarChar(500)
  eventDate     DateTime  @map("event_date") @db.Date
  startTime     String?   @map("start_time")
  endTime       String?   @map("end_time")
  venue         String?   @db.VarChar(200)
  capacity      Int?
  cancelDeadline DateTime? @map("cancel_deadline") @db.Timestamptz(6)
  statusId      String    @map("status_id") @db.Uuid
  publishAt     DateTime? @map("publish_at") @db.Timestamptz(6)
  allowGuest    Boolean   @default(false) @map("allow_guest")
  createdBy     String    @map("created_by") @db.Uuid
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  status        EventStatus        @relation(fields: [statusId], references: [id])
  creator       User               @relation("EventCreator", fields: [createdBy], references: [id])
  applications  EventApplication[]
  guestApplications GuestApplication[]

  @@map("events")
}

// イベント申込みテーブル（会員）
model EventApplication {
  id          String    @id @default(uuid()) @db.Uuid
  eventId     String    @map("event_id") @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  status      String    @default("applied") @db.VarChar(20) // 'applied', 'cancelled'
  appliedAt   DateTime  @default(now()) @map("applied_at") @db.Timestamptz(6)
  cancelledAt DateTime? @map("cancelled_at") @db.Timestamptz(6)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_applications")
}

// イベント申込みテーブル（非会員）
model GuestApplication {
  id          String    @id @default(uuid()) @db.Uuid
  eventId     String    @map("event_id") @db.Uuid
  email       String    @db.VarChar(255)
  fullName    String    @map("full_name") @db.VarChar(100)
  companyName String?   @map("company_name") @db.VarChar(200)
  jobTitle    String?   @map("job_title") @db.VarChar(100)
  status      String    @default("applied") @db.VarChar(20) // 'applied', 'cancelled'
  appliedAt   DateTime  @default(now()) @map("applied_at") @db.Timestamptz(6)
  cancelledAt DateTime? @map("cancelled_at") @db.Timestamptz(6)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("guest_applications")
}

// 管理者テーブル
model Administrator {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  name         String    @db.VarChar(100)
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  adminLogs AdminLog[]

  @@map("administrators")
}

// 管理者操作ログテーブル
model AdminLog {
  id        String    @id @default(uuid()) @db.Uuid
  adminId   String    @map("admin_id") @db.Uuid
  action    String    @db.VarChar(100)
  targetType String?  @map("target_type") @db.VarChar(50)
  targetId  String?   @map("target_id") @db.Uuid
  details   Json?
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  admin Administrator @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_logs")
}
